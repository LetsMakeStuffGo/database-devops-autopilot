# =============================================================================
# Flyway Configuration for CI/CD PIPELINE (GitHub Actions)
# =============================================================================
# This file uses environment variable resolution with ${env.VARIABLE_NAME} syntax
# Environment variables are securely provided through GitHub Secrets
# This file is safe to commit as it contains no sensitive information
# =============================================================================

id = "database-devops-autopilot-pipeline"
name = "Database DevOps AutoPilot (CI/CD Pipeline)"
databaseType = "SqlServer"

[environments.development]
# Environment variables resolved from GitHub Secrets during pipeline execution
url = "jdbc:sqlserver://${env.AZURE_SQL_SERVER}.database.windows.net:1433;databaseName=${env.FLYWAY_DEV_DATABASE};encrypt=true;trustServerCertificate=false"
user = "${env.AZURE_SQL_USER}"
password = "${env.AZURE_SQL_PASSWORD}"
displayName = "Development Database (CI/CD)"

[environments.shadow]
# Shadow database for automated validation in CI/CD pipeline
url = "jdbc:sqlserver://${env.AZURE_SQL_SERVER}.database.windows.net:1433;databaseName=${env.FLYWAY_SHADOW_DATABASE};encrypt=true;trustServerCertificate=false"
user = "${env.AZURE_SQL_USER}"
password = "${env.AZURE_SQL_PASSWORD}"
displayName = "Shadow Database (CI/CD Validation)"
provisioner = "clean"

[environments.uat]
# Environment variables resolved from GitHub Secrets during pipeline execution
url = "jdbc:sqlserver://${env.AZURE_SQL_SERVER}.database.windows.net:1433;databaseName=${env.FLYWAY_UAT_DATABASE};encrypt=true;trustServerCertificate=false"
user = "${env.AZURE_SQL_USER}"
password = "${env.AZURE_SQL_PASSWORD}"
displayName = "UAT Database (CI/CD)"

[environments.production]
# Production environment - requires manual approval in CI/CD pipeline
url = "jdbc:sqlserver://${env.AZURE_SQL_SERVER}.database.windows.net:1433;databaseName=${env.FLYWAY_PROD_DATABASE};encrypt=true;trustServerCertificate=false"
user = "${env.AZURE_SQL_USER}"
password = "${env.AZURE_SQL_PASSWORD}"
displayName = "Production Database (CI/CD)"

[flyway]
locations = [ "filesystem:migrations" ]
mixed = true
outOfOrder = true
validateMigrationNaming = true
defaultSchema = "Customers"
baselineOnMigrate = true
baselineVersion = "001"
errorOverrides = [ "S0001:0:I-" ]

[flyway.sqlserver.clean]
mode = "all"

[flyway.sqlserver.clean.schemas]
exclude = [ "ExampleSchema1", "ExampleSchema2" ]

[flywayDesktop]
developmentEnvironment = "development"
shadowEnvironment = "shadow"
schemaModel = "./schema-model"

[flywayDesktop.generate]
undoScripts = true

# =============================================================================
# REQUIRED GITHUB SECRETS (configured in repository settings):
# =============================================================================
# AZURE_SQL_SERVER          → Your Azure SQL Server name (without .database.windows.net)
# AZURE_SQL_USER             → Your Azure SQL username
# AZURE_SQL_PASSWORD         → Your Azure SQL password
# FLYWAY_DEV_DATABASE        → Development database name (e.g., db-autopilot-dev-001)
# FLYWAY_SHADOW_DATABASE     → Shadow database name (e.g., db-autopilot-shadow-001)
# FLYWAY_UAT_DATABASE        → UAT database name (e.g., db-autopilot-uat-001)
# FLYWAY_PROD_DATABASE       → Production database name (e.g., db-autopilot-prod-001)
# =============================================================================
#
# CI/CD PIPELINE FLOW:
# =============================================================================
# 1. Validate migrations against Shadow database (clean deployment test)
# 2. Deploy to UAT environment for acceptance testing
# 3. Manual approval gate for Production deployment
# 4. Deploy to Production environment with rollback capability
# =============================================================================

[flyway.sqlserver.clean.schemas]
exclude = [ "ExampleSchema1", "ExampleSchema2" ]

[flywayDesktop]
developmentEnvironment = "development"

# =============================================================================
# REQUIRED GITHUB SECRETS (configured in repository settings):
# =============================================================================
# AZURE_SQL_SERVER          → Your Azure SQL Server name (without .database.windows.net)
# AZURE_SQL_USER             → Your Azure SQL username
# AZURE_SQL_PASSWORD         → Your Azure SQL password
# FLYWAY_DEV_DATABASE        → Development database name
# FLYWAY_UAT_DATABASE        → UAT database name
# =============================================================================